<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Tracker Pro</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg: #f8fafc;
            --text: #334155;
            --danger: #ef4444;
            --warning: #f59e0b;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
        }

        /* Helpers */
        .hidden { display: none !important; }
        .container { padding: 20px; }
        .center-content { min-height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .primary { background-color: var(--primary); color: var(--white); }
        .primary:hover { background-color: var(--primary-dark); }
        .secondary { background-color: #e2e8f0; color: var(--text); }
        .secondary:hover { background-color: #cbd5e1; }
        .accent { background-color: #6366f1; color: white; }
        .accent:hover { background-color: #4f46e5; }
         
        .icon-btn { 
            padding: 6px; 
            border-radius: 4px; 
            background: #f1f5f9; 
            color: #64748b; 
            border: 1px solid transparent;
            cursor: pointer;
        }
        .icon-btn:hover { background: #e2e8f0; color: var(--text); }
        .icon-btn.danger:hover { background: #fee2e2; color: var(--danger); }
        
        .qty-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: #e2e8f0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: var(--text);
        }
        .qty-btn:hover { background: #cbd5e1; }

        /* Login */
        .login-card { background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 350px; }
        .login-card h1 { color: var(--primary-dark); margin-bottom: 5px; }

        /* Navbar */
        .navbar { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .nav-brand { font-size: 1.25rem; font-weight: bold; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }

        /* Dashboard */
        .main-content { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .stat-card h3 { font-size: 0.875rem; color: #64748b; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card span { font-size: 2rem; font-weight: bold; }
        .stat-card.danger span { color: var(--danger); }
        .stat-card.warning span { color: var(--warning); }
        .stat-card.info span { color: #3b82f6; }

        /* Action Bar */
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .search-wrapper { flex: 1; display: flex; gap: 0; position: relative; min-width: 200px; }
        #search-input { width: 100%; padding: 10px 12px; padding-right: 40px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; }
        #search-input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        #search-input.scanning { outline: 2px solid #6366f1; background-color: #eef2ff; }
        
        .filter-select {
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background-color: white;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
            min-width: 140px;
        }
        .filter-select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Table */
        .table-container { background: var(--white); border-radius: 8px; overflow-x: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 700px; }
        th, td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }
        
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
        .badge.expired { background: #fee2e2; color: #991b1b; }
        .badge.warning { background: #fef3c7; color: #92400e; }
        .badge.good { background: #d1fae5; color: #065f46; }
        .badge.low { background: #dbeafe; color: #1e40af; }

        /* Quantity Control */
        .qty-control { display: flex; align-items: center; gap: 8px; }
        .qty-display { font-family: monospace; font-size: 1rem; font-weight: 600; width: 30px; text-align: center; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.2s; }
        .modal { background: var(--white); padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s; }
        .modal h2 { margin-top: 0; color: var(--text); border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.875rem; font-weight: 500; color: #475569; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .form-group input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .form-group.checkbox { display: flex; align-items: center; gap: 10px; }
        .form-group.checkbox input { width: auto; margin: 0; }
        .form-group.checkbox label { margin: 0; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
        .modal-actions button { flex: 1; padding: 12px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Empty State */
        .empty-state { padding: 40px; text-align: center; color: #94a3b8; }
        .empty-icon { font-size: 3rem; margin-bottom: 10px; display: block; opacity: 0.5; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="container center-content">
        <div class="card login-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üè•</div>
            <h1>MediTrack Pro</h1>
            <p style="color: #64748b; margin-bottom: 2rem;">Inventory & Expiry Management</p>
            <button id="login-btn" class="btn primary" style="width: 100%">Access Dashboard</button>
            <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 1rem;">*Demo Mode: Anonymous Login</p>
        </div>
    </div>

    <!-- Dashboard Screen (Hidden by default) -->
    <div id="dashboard-screen" class="hidden">
        <nav class="navbar">
            <div class="nav-brand">
                <span>üè•</span> MediTrack Pro
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="settings-btn" class="btn secondary" title="Settings">‚öôÔ∏è Settings</button>
                <button id="logout-btn" class="btn secondary">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <!-- Stats Row -->
            <div class="stats-grid">
                <div class="stat-card info">
                    <h3>Total Stock</h3>
                    <span id="total-count">0</span>
                </div>
                <div class="stat-card warning">
                    <h3>Expiring Soon</h3>
                    <span id="expiring-count">0</span>
                </div>
                <div class="stat-card danger">
                    <h3>Expired</h3>
                    <span id="expired-count">0</span>
                </div>
                <div class="stat-card">
                    <h3>Low Stock</h3>
                    <span id="low-stock-count">0</span>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <button id="scan-mode-btn" class="btn accent" title="Click to use Barcode Scanner">
                    üì∑ Scan Barcode
                </button>
                
                <div class="search-wrapper">
                    <input type="text" id="search-input" placeholder="Search name, batch, or barcode...">
                </div>

                <!-- NEW FILTER DROPDOWN -->
                <select id="filter-status" class="filter-select">
                    <option value="all">All Statuses</option>
                    <option value="expired">‚ö†Ô∏è Expired</option>
                    <option value="warning">‚è≥ Expiring Soon</option>
                    <option value="low">üìâ Low Stock</option>
                    <option value="good">‚úÖ Good Stock</option>
                </select>

                <button id="add-btn" class="btn primary">+ Add Medicine</button>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Medicine Details</th>
                            <th>Status</th>
                            <th>Expiry Date</th>
                            <th>Quantity</th>
                            <th style="text-align: right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list">
                        <!-- Items will be injected here by JS -->
                    </tbody>
                </table>
                <div id="loading-spinner" style="padding: 40px; text-align: center; color: #64748b;">
                    Loading inventory...
                </div>
                <div id="empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    No medicines found.
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Medicine Modal -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal">
            <h2 id="modal-title">Add New Stock</h2>
            <form id="med-form">
                <input type="hidden" id="med-id"> <!-- Hidden ID for edits -->
                
                <div class="form-group">
                    <label>Barcode / ID</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="med-barcode" placeholder="Scan or type barcode" style="flex:1">
                        <button type="button" class="btn secondary" id="barcode-help">üì∑</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Medicine Name</label>
                    <input type="text" id="med-name" required placeholder="e.g. Paracetamol 500mg">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Batch Number</label>
                        <input type="text" id="med-batch" required placeholder="B-123">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="med-qty" required min="0" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Expiry Date</label>
                    <input type="date" id="med-date" required>
                    <small id="expiry-hint" style="color: #94a3b8; font-size: 0.75rem;">Alerts based on settings</small>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-btn" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn primary">Save Medicine</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2>Preferences</h2>
            <form id="settings-form">
                <div class="form-group">
                    <label>Reminder Threshold (Days)</label>
                    <input type="number" id="setting-threshold" min="1" max="365" value="30">
                    <small style="color: #64748b">Alert when expiry is within this many days.</small>
                </div>
                <div class="form-group checkbox">
                    <input type="checkbox" id="setting-notifications">
                    <label for="setting-notifications">Enable Browser Notifications</label>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #f1f5f9; margin: 20px 0;">
                
                <div style="text-align: center;">
                    <button type="button" id="load-demo-btn" class="btn secondary" style="width: 100%;">
                        üì• Reload Demo Data
                    </button>
                </div>

                <div class="modal-actions">
                    <button type="button" onclick="document.getElementById('settings-modal').classList.add('hidden')" class="btn secondary">Close</button>
                    <button type="submit" class="btn primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // NOTE: The app expects these globals to be provided at build/runtime.
        // For local testing you can set window.__firebase_config and window.__app_id before loading the script.
        // Example (in browser console):
        // window.__firebase_config = JSON.stringify({ apiKey: "...", authDomain: "...", projectId: "..." });
        // window.__app_id = 'my-demo-app';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
            ? JSON.parse(__firebase_config)
            : null; // replace with your config or set window.__firebase_config before running
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'default-app-id';

        // If firebase config is missing, app will run in demo-only mode (no persistence)
        let app, auth, db;
        try {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn('Firebase config not found. Running in demo mode (no persistence).');
            }
        } catch (e) {
            console.error('Firebase init error:', e);
        }
        
        let currentUser = null;
        let medicines = []; 
        let unsubscribeMeds = null;
        let hasCheckedEmpty = false; // Prevents infinite loop on auto-load
        
        // Default Settings
        let userSettings = {
            threshold: 30,
            notifications: false
        };

        // --- DOM Elements ---
        const screens = {
            login: document.getElementById('login-screen'),
            dashboard: document.getElementById('dashboard-screen')
        };
        const modals = {
            med: document.getElementById('modal-overlay'),
            settings: document.getElementById('settings-modal')
        };
        const searchInput = document.getElementById('search-input');
        const filterStatus = document.getElementById('filter-status');

        // --- Auth helpers ---
        async function initAuth() {
            if (!auth) return; // demo mode
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){console.warn(e)}
            }
        }
        initAuth();

        document.getElementById('login-btn').addEventListener('click', async () => {
            if (!auth) { // demo mode - show dashboard without firebase
                currentUser = { uid: 'demo-user' };
                screens.login.classList.add('hidden');
                screens.dashboard.classList.remove('hidden');
                await loadSettings();
                injectDemoData();
                return;
            }
            try { await signInAnonymously(auth); } catch(e){ console.error(e); }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (unsubscribeMeds) unsubscribeMeds();
            if (auth) signOut(auth).catch(()=>{});
            currentUser = null;
            hasCheckedEmpty = false;
            screens.login.classList.remove('hidden');
            screens.dashboard.classList.add('hidden');
        });

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    screens.login.classList.add('hidden');
                    screens.dashboard.classList.remove('hidden');
                    await loadSettings();
                    loadMedicines();
                } else {
                    screens.login.classList.remove('hidden');
                    screens.dashboard.classList.add('hidden');
                }
            });
        }

        // --- Settings Logic ---
        async function loadSettings() {
            try {
                if (!db || !currentUser) return;
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'preferences');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    userSettings = { ...userSettings, ...docSnap.data() };
                }
            } catch (e) {
                console.log('Using default settings');
            }
            // Update UI
            document.getElementById('setting-threshold').value = userSettings.threshold;
            document.getElementById('setting-notifications').checked = !!userSettings.notifications;
            document.getElementById('expiry-hint').innerText = `Alerts trigger ${userSettings.threshold} days before expiry`;
        }

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newSettings = {
                threshold: Number(document.getElementById('setting-threshold').value),
                notifications: document.getElementById('setting-notifications').checked
            };
            if (db && currentUser) {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'preferences'), newSettings);
                } catch(e){console.error(e)}
            }
            userSettings = newSettings;
            if (userSettings.notifications && Notification.permission !== 'granted') Notification.requestPermission();
            modals.settings.classList.add('hidden');
            applyFilters();
            updateStats(medicines);
        });

        document.getElementById('settings-btn').addEventListener('click', () => modals.settings.classList.remove('hidden'));

        // --- Data Logic ---
        function loadMedicines() {
            if (!db || !currentUser) return injectDemoData();
            const medsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines');
            unsubscribeMeds = onSnapshot(medsRef, (snapshot) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                medicines = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                medicines.sort((a,b)=> new Date(a.expiryDate) - new Date(b.expiryDate));
                if (snapshot.empty && !hasCheckedEmpty) {
                    hasCheckedEmpty = true;
                    injectDemoData();
                }
                applyFilters();
                updateStats(medicines);
                checkNotifications(medicines);
            }, (err)=>{ console.error('Snapshot error', err); document.getElementById('loading-spinner').classList.add('hidden'); });
        }

        function applyFilters() {
            const term = (searchInput.value || '').toLowerCase();
            const statusFilter = filterStatus.value || 'all';
            const filtered = medicines.filter(med => {
                const name = (med.name||'').toLowerCase();
                const batch = (med.batchNumber||med.batch||'').toLowerCase();
                const barcode = (med.barcode||'').toLowerCase();
                const matchesSearch = !term || name.includes(term) || batch.includes(term) || barcode.includes(term);
                if (!matchesSearch) return false;
                if (statusFilter === 'all') return true;
                const status = getStatus(med.expiryDate, med.quantity);
                return status.type === statusFilter;
            });
            renderTable(filtered);
        }

        function renderTable(data) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            if (!data || data.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }
            data.forEach(med => {
                const status = getStatus(med.expiryDate, med.quantity);
                const row = document.createElement('tr');
                const barcodeDisplay = med.barcode ? `<div style="font-family:monospace; color:#64748b; font-size:0.75rem">||| ${med.barcode}</div>` : '';
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: var(--text)">${escapeHtml(med.name)}</div>
                        <div style="font-size: 0.75rem; color: #64748b">Batch: ${escapeHtml(med.batchNumber||med.batch||'')}</div>
                        ${barcodeDisplay}
                    </td>
                    <td><span class="badge ${status.type}">${status.icon} ${status.label}</span></td>
                    <td style="color: #64748b">${escapeHtml(med.expiryDate)}</td>
                    <td>
                        <div class="qty-control">
                            <button class="qty-btn" data-id="${med.id}" data-dir="-1">-</button>
                            <span class="qty-display">${Number(med.quantity)||0}</span>
                            <button class="qty-btn" data-id="${med.id}" data-dir="1">+</button>
                        </div>
                    </td>
                    <td style="text-align: right">
                        <button class="icon-btn edit-btn" data-id="${med.id}" title="Edit Details">‚úèÔ∏è</button>
                        <button class="icon-btn danger delete-btn" data-id="${med.id}" title="Delete">üóëÔ∏è</button>
                    </td>
                `;
                list.appendChild(row);
            });
            // Attach delegated handlers
            attachTableHandlers();
        }

        function getStatus(dateString, quantity) {
            const today = new Date();
            const expiry = new Date(dateString);
            const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
            if (isNaN(diffDays)) return { type: 'good', label: 'Unknown', icon: '‚ÑπÔ∏è' };
            if (diffDays < 0) return { type: 'expired', label: 'Expired', icon: '‚ö†Ô∏è' };
            if (diffDays <= userSettings.threshold) return { type: 'warning', label: `Expires in ${diffDays}d`, icon: '‚è≥' };
            if ((Number(quantity) || 0) <= 10) return { type: 'low', label: 'Low Stock', icon: 'üìâ' };
            return { type: 'good', label: 'Good', icon: '‚úÖ' };
        }

        function updateStats(data) {
            let total = 0, expired = 0, soon = 0, low = 0;
            const today = new Date();
            (data||[]).forEach(med => {
                total++;
                const expiry = new Date(med.expiryDate);
                const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                if (!isNaN(diffDays)) {
                    if (diffDays < 0) expired++;
                    else if (diffDays <= userSettings.threshold) soon++;
                }
                if ((Number(med.quantity)||0) <= 10) low++;
            });
            document.getElementById('total-count').innerText = total;
            document.getElementById('expired-count').innerText = expired;
            document.getElementById('expiring-count').innerText = soon;
            document.getElementById('low-stock-count').innerText = low;
        }

        function checkNotifications(data) {
            if (!userSettings.notifications || Notification.permission !== 'granted') return;
            const expiredCount = (data||[]).filter(m => getStatus(m.expiryDate, m.quantity).type === 'expired').length;
            if (expiredCount > 0) {
                // Implement notifications if required
            }
        }

        // --- Actions ---
        async function changeQuantity(id, change) {
            if (!id) return;
            const med = medicines.find(m => m.id === id);
            if (!med) return;
            const newQty = (Number(med.quantity)||0) + Number(change);
            if (newQty < 0) return;
            if (db && currentUser) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines', id), { quantity: newQty, updatedAt: serverTimestamp() });
                } catch(e){ console.error(e); }
            } else {
                med.quantity = newQty;
                applyFilters();
                updateStats(medicines);
            }
        }

        async function deleteMedById(id) {
            if (!id) return;
            if (!confirm('Delete this medicine?')) return;
            if (db && currentUser) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines', id)); } catch(e){ console.error(e); }
            } else {
                medicines = medicines.filter(m => m.id !== id);
                applyFilters();
                updateStats(medicines);
            }
        }

        function openEditById(id) {
            const med = medicines.find(m => m.id === id);
            if (!med) return;
            document.getElementById('modal-title').innerText = 'Edit Medicine';
            document.getElementById('med-id').value = id;
            document.getElementById('med-name').value = med.name || '';
            document.getElementById('med-batch').value = med.batchNumber || med.batch || '';
            document.getElementById('med-qty').value = Number(med.quantity) || 0;
            document.getElementById('med-date').value = med.expiryDate || '';
            document.getElementById('med-barcode').value = med.barcode || '';
            modals.med.classList.remove('hidden');
        }

        // Attach delegated handlers for the table buttons
        function attachTableHandlers() {
            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.onclick = () => changeQuantity(btn.dataset.id, btn.dataset.dir);
            });
            document.querySelectorAll('.delete-btn').forEach(b => { b.onclick = () => deleteMedById(b.dataset.id); });
            document.querySelectorAll('.edit-btn').forEach(b => { b.onclick = () => openEditById(b.dataset.id); });
        }

        // --- Demo Data Loading ---
        async function injectDemoData() {
            const today = new Date();
            const getOffsetDate = (days) => { const d = new Date(); d.setDate(today.getDate() + days); return d.toISOString().split('T')[0]; };
            const samples = [
                { name: 'Amoxicillin 500mg', batchNumber: 'AX-24', quantity: 100, expiryDate: getOffsetDate(365), barcode: '11111' },
                { name: 'Ibuprofen 400mg', batchNumber: 'IB-90', quantity: 50, expiryDate: getOffsetDate(180), barcode: '22222' },
                { name: 'Cetirizine 10mg', batchNumber: 'CT-55', quantity: 200, expiryDate: getOffsetDate(200), barcode: '33333' },
                { name: 'Metformin 500mg', batchNumber: 'MT-12', quantity: 60, expiryDate: getOffsetDate(90), barcode: '44444' },
                { name: 'Omeprazole 20mg', batchNumber: 'OM-88', quantity: 30, expiryDate: getOffsetDate(400), barcode: '55555' },
                { name: 'Azithromycin 250mg', batchNumber: 'AZ-01', quantity: 5, expiryDate: getOffsetDate(120), barcode: '66666' },
                { name: 'Prednisone 5mg', batchNumber: 'PR-33', quantity: 8, expiryDate: getOffsetDate(60), barcode: '77777' },
                { name: 'Aspirin 75mg', batchNumber: 'AS-11', quantity: 100, expiryDate: getOffsetDate(15), barcode: '88888' },
                { name: 'Lisinopril 10mg', batchNumber: 'LS-22', quantity: 45, expiryDate: getOffsetDate(5), barcode: '99999' },
                { name: 'Vitamin C 500mg', batchNumber: 'VC-00', quantity: 20, expiryDate: getOffsetDate(-10), barcode: '00000' }
            ];

            if (db && currentUser) {
                const promises = samples.map(item => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines'), { ...item, createdAt: serverTimestamp() }));
                try { await Promise.all(promises); } catch(e){ console.error('Error injecting demo data:', e); }
                return;
            }

            // Local demo fallback (no persistence)
            medicines = samples.map((s, i) => ({ id: 'demo-' + i, ...s }));
            applyFilters();
            updateStats(medicines);
        }

        document.getElementById('load-demo-btn').addEventListener('click', async () => {
            if (!confirm('Add 10 demo medicines?')) return;
            await injectDemoData();
            modals.settings.classList.add('hidden');
        });

        // --- Scan Mode ---
        document.getElementById('scan-mode-btn').addEventListener('click', () => {
            const input = document.getElementById('search-input');
            input.focus();
            input.classList.add('scanning');
            input.placeholder = 'WAITING FOR SCANNER INPUT...';
            const simulatedCode = prompt('Simulate Scan: Enter a barcode (e.g., 11111 for Amoxicillin):', '');
            if (simulatedCode) { input.value = simulatedCode; input.dispatchEvent(new Event('input')); }
            setTimeout(() => { input.classList.remove('scanning'); input.placeholder = 'Search name, batch, or barcode...'; }, 3000);
        });

        // --- Form Handling ---
        document.getElementById('med-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('med-id').value;
            const data = {
                name: document.getElementById('med-name').value,
                batchNumber: document.getElementById('med-batch').value,
                quantity: Number(document.getElementById('med-qty').value),
                expiryDate: document.getElementById('med-date').value,
                barcode: document.getElementById('med-barcode').value,
                updatedAt: serverTimestamp()
            };
            if (db && currentUser) {
                try {
                    if (id) await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines', id), data);
                    else await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'medicines'), { ...data, createdAt: serverTimestamp() });
                } catch(e){ console.error(e); }
            } else {
                if (id) {
                    const m = medicines.find(x=>x.id===id);
                    if (m) Object.assign(m, data);
                } else {
                    medicines.unshift({ id: 'demo-' + Date.now(), ...data });
                }
                applyFilters();
                updateStats(medicines);
            }
            modals.med.classList.add('hidden');
            e.target.reset();
        });

        // --- Search & Filter Events ---
        searchInput.addEventListener('input', applyFilters);
        filterStatus.addEventListener('change', applyFilters);

        // --- Modal Toggles ---
        document.getElementById('add-btn').addEventListener('click', () => {
            document.getElementById('modal-title').innerText = 'Add New Stock';
            document.getElementById('med-id').value = ''; // Clear ID for new add
            document.getElementById('med-form').reset();
            modals.med.classList.remove('hidden');
            setTimeout(() => document.getElementById('med-barcode').focus(), 100);
        });

        document.getElementById('cancel-btn').addEventListener('click', () => modals.med.classList.add('hidden'));

        // --- Small utilities ---
        function escapeHtml(str){ if(str==null) return ''; return String(str).replace(/[&"'<>]/g, function (s) { return ({ '&':'&amp;','"':'&quot;','\'':'&#39;','<':'&lt;','>':'&gt;' })[s]; }); }

        // Auto-load demo if no firebase is configured
        if (!firebaseConfig) {
            // allow user to enter demo quickly
        }

    </script>
</body>
</html>